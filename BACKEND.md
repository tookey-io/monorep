# Structure

- Internet
- `Backend` on NodeJS
- RabbitMQ
- `Manager` on Rust

- Internet
- `Relay` (former manager) on Rust

# Processes
## Registration

1. Open frontend
2. Open registration
   1. Fill email, password fields 
   2. Submit to API (`/api/sign_up`)
   3. Parse user and login information from response
      1. Login information contains auth_token for API authorization and refresh_token for updating auth_token
3. Opens page with confirmations configuration
   1. Examples: GoogleAuthenticator, Telegram message, KYC, SMS, Call, YubiKey
   2. GoogleAuthenticator and Telegram message are easy to implement (and could be used as second factor on login page ?)
   3. -
   4. Submit to APIs (`/api/user/confirmations/`)


## Key generation

Case with 1 web user and 1 wallet app

1. Opens empty public keys list (`/api/public_keys`)
   1. Click create new key
   2. Fill name, description, tags
   3. Fill participants (Numbered list)
      1. First participant is always current user (id 1)
      2. Required to be at least 2
   4. Fill threshold (Number of participants to sign message)
   5. Fill keygen timeout
   6. Submit
2. Opens key generation page
   1. Displays qr codes and links for other devices (contains room id, key name, participant index, participants count and participants threshold)
   2. Displays progress in form checkmarks for every participant (status in `/api/public_keys/id` in field `participants_confirmations`)
   3. Displays timeout until field `expires at`
3. [WALLET] Open wallet app, scan qr code
   1. Display progress if not last
   2. After keygen is finished, setup passphrase
4. In web app user receives successful keygen status
   1. Sees generated public key, can update name, description, can destroy


## Message signing

Case with 1 web user and 1 wallet app

1. Open web app
   1. Open sign modal
   2. Select key
   3. Select participants (current user is always selected)
   4. Fill data, metadata fields (automatic)
   5. Select timeout
   6. Submit (`/api/sign`)
2. On sign page user can view progress (participants should sign in sorted index order)
3. In wallet user receives notification (No need to scan qr code)
   1. When previous user signed message (Automatic for first user), wallet can sign message
4. When all participants signed, sign page will display result

# API Specs
## Backend

Backend DB:
- Users
  - id: UUID
  - email: String
  - telegram_id: i64
  - password: argon2id hashed
- Keys
  - id: UUID
  - room_id: UUID (Generated by backend, Cleared after process is finished)
  - timeout_seconds: u64 (For generation)
  - timeout_at: UTC Timestamp (For generation)
  - status: Enum[Created,Started,Finished,Error,Timeout]
  - active_indexes: u16[]
  - public_key: String
  - participants: { index: u16, description: String }
  - participants_threshold: u16
  - name: String
  - description: String
  - tags: String[]
- UsersPublicKeys
  - user_id: UUID
  - key_id: UUID
  - participant_index: u16 (Index of user in keys participants, default is 1 for first user)
  - required_authorizations: ? (Key can require different verifications from specific user)
- Signs
  - [Destroyed/Moved to archive after timeout]
  - id: UUID (for relay)
  - room_id: UUID (Generated by backend, Cleared after process is finished)
  - key_id: UUID (for relay)
  - data: String (for relay)
  - metadata: JSON (for users and wallets)
  - participant_indexes: u16[]
  - timeout_seconds: u64
  - timeout_at: UTC Timestamp
  - status: Enum[Created,Started,Finished,Error,Timeout]
  - active_indexes: u16[]
  - result: Option<String>

#### Requests
- POST `/api/sign_up`
  - Creates user
  - Parameters:
    - email: String
    - password: String
    - password_confirmation: String
  - Response: User
- POST `/api/login`
  - Authorizes user
  - Parameters:
    - email: String
    - password: String
    - otp: String
  - Response: Login
- POST `/api/refresh_token`
  - Refreshes authorization token
  - Parameters:
    - refresh_token: String
  - Response: Login
- PUT `/api/user`
  - Update user profile
  - Parameters:
    - email: String
    - password: String
    - password_confirmation: String
- GET `/api/me`
  - Fetch user info
  - Response: User

- GET `/api/keys`
  - List accessible keys
  - Response: PublicKey[]
- GET `/api/keys/:id`
  - Fetch key information (id, generation status, signatures)
  - Response: PublicKey
- POST `/api/keys`
  - Create new public key
  - Parameters:
    - name: String
    - description: String
    - tags: []
    - participants: { index: u16, description: String }[]
    - participants_threshold: u16
    - timeout_seconds: u64
  - Response: PublicKey
- PUT `/api/keys/:id`
  - Update public key fields
  - Parameters:
    - name: String
    - description: String
    - tags: []
    - participants: { index: u16, description: String }[] (Updates only descriptions)
  - Response: PublicKey
- POST `/api/keys/:id/restart`
  - Restart key generation if status is `error | timeout`
  - Parameters:
    - timeout_seconds: u64
  - Response: PublicKey
- DELETE `/api/keys/:id`
  - Destroy public key
  - Response: PublicKey[]

- POST `/api/keys/:id/sign`
  - Creates new sign request
  - Parameters:
    - data: String (for relay)
    - metadata: JSON (for users and wallets)
    - participant_indexes: u16[]
  - Response: PublicKey
- POST `/api/keys/:id/sign/:id/restart`
  - Restart sign if status is `error | timeout`
  - Parameters:
    - timeout_seconds: u64
  - Response: PublicKey

## Manager

Responses are sent when model is changed.

#### Responses
- Keygen status (sent on keygen request creation, change and finish):
  - action: keygen_status
  - room_id: UUID
  - status: Enum[Created,Started,Finished,Error,Timeout]
  - active_indexes: Vec<u16>
  - public_key: Option<String>
- Sign status (sent on sign request creation, change and finish):
  - action: sign_status
  - room_id: UUID
  - status: Enum[Created,Started,Finished,Error,Timeout]
  - active_indexes: Vec<u16>
  - result: Option<String>


#### Available actions
- keygen_join
  - Join keygen process for user
    - Sends Keygen status with each join, and final with finished/error/timeout status
    - Stores key for user in Hashicorp Vault, accessible by sign_approve action
  - Parameters:
    - user_id: UUID (Needed for key storage)
    - key_id: UUID (Generated by backend)
    - room_id: UUID (Generated by backend)
    - relay_address: String (Selected by backend)
    - timeout_seconds: u64 (Fails keygen after timeout seconds, for example if wallet is not joining)
    - participant_index: u16
    - participants_count: u16
    - participants_threshold: u16

- sign_approve
  - Starts signing process
    - Sends sign status with each join, and final with finished/error/timeout status
  - Parameters:
    - user_id: UUID (Needed for key storage)
    - key_id: UUID (Needed for key storage, Generated by backend)
    - room_id: UUID (Generated by backend)
    - relay_address: String (Selected by backend)
    - timeout_seconds: u64 (Fails keygen after timeout seconds, for example if wallet is not joining)
    - data: String (for relay)
    - participant_indexes: u16[]

- destroy_key (WIP, maybe require sign)
  - Removes key from Vault
  - Parameters:
    - user_id: UUID
    - key_id: UUID 
